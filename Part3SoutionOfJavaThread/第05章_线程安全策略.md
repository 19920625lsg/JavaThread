# 第05章 线程安全策略

## 5.1~5.2 不可变对象

### 不可变对象需要满足的条件

+ 对象创建后其状态就不能修改
+ 对象所有域都是final类型
+ 对象是正确创建地(在对象创建期间，this引用没有逸出)

### final关键字

> 可以修饰类、方法和变量

+ 修饰类：不能被继承
+ 修饰方法：
  + 1.锁定方法不能被继承类修改
  + 2.效率高
+ 修饰变量：
  + 1.基本数据类型：数值一旦初始化后便不能修改了
  + 2.引用类型变量：初始化后就不能指向另外一个对象了
+ 修饰方法参数：通修饰变量

### 创建不可变对象的方式(参考String)

+ 将类声明称final类型，使其不可以被继承
+ 将所有的成员设置成私有的，使其他的类和对象不能直接访问这些成员
+ 对变量不提供set方法
+ 将所有可变的成员声明为final，这样只能对他们赋值一次
+ 通过构造器初始化所有成员，进行深度拷贝
+ 在get方法中，不直接返回对象本身，而是克隆对象，返回对象的拷贝

### 使用工具类来完成不可变对象的创建

+ `Collections.unmodifiableXXX`：Collection、List、Set、Map...
+ `Guava`：ImmutableXXX：Collection、List、Set、Map...

```java
@Slf4j
public class ImmutableExample2 {

    private static Map<Integer, Integer> map = Maps.newHashMap();

    static {
        map.put(1, 2);
        // 转换成不可变对象
        map = Collections.unmodifiableMap(map);
    }

    public static void main(String[] args) {
        // 此时map就是不可变对象了，修改会报错
        map.put(1, 3);
        log.info("{}", map.get(1));
    }
}
```
